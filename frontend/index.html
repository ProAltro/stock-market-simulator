<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Decrypt - Algorithmic Trading Competition Platform"
    />
    <title>Decrypt | Algorithmic Trading Competition</title>

    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="/assets/styles.css" />

    <!-- Monaco Editor AMD loader (same approach as Judge0 IDE) -->
    <script>
      var require = {
        paths: {
          vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs",
        },
      };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/editor/editor.main.nls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.44.0/min/vs/editor/editor.main.js"></script>

    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
  </head>
  <body>
    <div id="initial-loader" class="loading-screen">
      <div class="loader">
        <div class="loader-ring"></div>
        <span>Loading Decrypt...</span>
      </div>
    </div>

    <div id="app-root" style="display: none">
      <div x-data="app()" x-init="init()">
        <div id="auth-container"></div>

        <div id="sidebar-container"></div>

        <button class="mobile-menu-btn" @click="sidebarOpen = !sidebarOpen">
          &#9776;
        </button>
        <div
          class="sidebar-overlay"
          :class="{ active: sidebarOpen }"
          @click="sidebarOpen = false"
        ></div>

        <main class="main-content">
          <div id="pages-container"></div>
        </main>
      </div>
    </div>

    <script type="module">
      async function loadTemplate(path, targetSelector, position = "replace") {
        try {
          const response = await fetch(`${path}?refresh=${Date.now()}`);
          if (!response.ok) {
            console.error(`Failed to load template: ${path}`);
            return false;
          }

          const html = await response.text();
          const target = document.querySelector(targetSelector);

          if (!target) {
            console.error(`Target element not found: ${targetSelector}`);
            return false;
          }

          switch (position) {
            case "append":
              target.insertAdjacentHTML("beforeend", html);
              break;
            case "prepend":
              target.insertAdjacentHTML("afterbegin", html);
              break;
            case "replace":
            default:
              target.innerHTML = html;
              break;
          }

          return true;
        } catch (error) {
          console.error(`Error loading template ${path}:`, error);
          return false;
        }
      }

      async function initApp() {
        try {
          await loadTemplate(
            "/components/auth-modal.html",
            "#auth-container",
            "replace",
          );

          await loadTemplate(
            "/components/sidebar.html",
            "#sidebar-container",
            "replace",
          );

          const pages = [
            "/pages/dashboard.html",
            "/pages/compete.html",
            "/pages/leaderboard.html",
            "/pages/market.html",
            "/pages/docs.html",
          ];

          for (const page of pages) {
            await loadTemplate(page, "#pages-container", "append");
          }

          console.log("Templates loaded successfully");

          document.getElementById("initial-loader").style.display = "none";
          document.getElementById("app-root").style.display = "block";

          // Load app module (defines window.app) before Alpine initializes
          await import(`/assets/js/main.js?v=${Date.now()}`);

          // Load Alpine.js and wait for it to be ready
          await new Promise((resolve, reject) => {
            const alpineScript = document.createElement("script");
            alpineScript.src =
              "https://cdn.jsdelivr.net/npm/alpinejs@3.14.9/dist/cdn.min.js";
            alpineScript.onload = resolve;
            alpineScript.onerror = () =>
              reject(new Error("Failed to load Alpine.js"));
            document.body.appendChild(alpineScript);
          });
        } catch (error) {
          console.error("Failed to initialize app:", error);
          document.getElementById("initial-loader").innerHTML = `
            <div class="loader">
              <span style="color: red;">Failed to load application. Please refresh the page.</span>
            </div>
          `;
        }
      }

      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initApp);
      } else {
        initApp();
      }
    </script>
  </body>
</html>
