<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="Decrypt - Paper Trading Platform for learning stock market trading"
    />
    <title>Decrypt | Paper Trading Platform</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
      rel="stylesheet"
    />

    <!-- Styles -->
    <link rel="stylesheet" href="/assets/styles.css" />

    <!-- TradingView Lightweight Charts -->
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

    <!-- Ace Editor -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.7/ace.min.js"></script>
  </head>
  <body>
    <!-- Initial Loading Screen (before templates load) -->
    <div id="initial-loader" class="loading-screen">
      <div class="loader">
        <div class="loader-ring"></div>
        <span>Loading Decrypt...</span>
      </div>
    </div>

    <!-- App Root - Templates injected here, then Alpine initializes -->
    <div id="app-root" style="display: none">
      <!-- Auth Container - Loaded from components/auth-modal.html -->
      <div id="auth-container"></div>

      <!-- Main App -->
      <div x-show="user" x-transition class="app-container">
        <!-- Sidebar Container - Loaded from components/sidebar.html -->
        <div id="sidebar-container"></div>

        <!-- Mobile hamburger & overlay -->
        <button
          class="mobile-menu-btn"
          @click="sidebarOpen = !sidebarOpen"
          x-show="user"
        >
          &#9776;
        </button>
        <div
          class="sidebar-overlay"
          :class="{ active: sidebarOpen }"
          @click="sidebarOpen = false"
        ></div>

        <!-- Main Content -->
        <main class="main-content">
          <!-- Pages Container - All pages loaded here -->
          <div id="pages-container"></div>
        </main>
      </div>
    </div>

    <!-- App core logic - must load first to define app() function -->
    <!-- App core logic - must load first to define app() function -->
    <script type="module" id="main-script"></script>
    <script>
      document.getElementById("main-script").src =
        "/assets/js/main.js?v=" + Date.now();
    </script>

    <!-- App Initialization Script -->
    <script type="module">
      // Load templates first, then Alpine.js
      async function loadTemplate(path, targetSelector, position = "replace") {
        try {
          const response = await fetch(`${path}?refresh=${Date.now()}`);
          if (!response.ok) {
            console.error(`Failed to load template: ${path}`);
            return false;
          }

          const html = await response.text();
          const target = document.querySelector(targetSelector);

          if (!target) {
            console.error(`Target element not found: ${targetSelector}`);
            return false;
          }

          switch (position) {
            case "append":
              target.insertAdjacentHTML("beforeend", html);
              break;
            case "prepend":
              target.insertAdjacentHTML("afterbegin", html);
              break;
            case "replace":
            default:
              target.innerHTML = html;
              break;
          }

          return true;
        } catch (error) {
          console.error(`Error loading template ${path}:`, error);
          return false;
        }
      }

      async function initApp() {
        try {
          // Load auth modal
          await loadTemplate(
            "/components/auth-modal.html",
            "#auth-container",
            "replace",
          );

          // Load sidebar
          await loadTemplate(
            "/components/sidebar.html",
            "#sidebar-container",
            "replace",
          );

          // Load all pages
          const pages = [
            "/pages/dashboard.html",
            "/pages/trade.html",
            "/pages/portfolio.html",
            "/pages/leaderboard.html",
            "/pages/backtest.html",
            "/pages/profile.html",
            "/pages/docs.html",
            "/pages/market-sim.html",
            "/pages/market-sim-admin.html",
          ];

          for (const page of pages) {
            await loadTemplate(page, "#pages-container", "append");
          }

          console.log("Templates loaded successfully");

          // Add Alpine.js x-data to app root
          const appRoot = document.getElementById("app-root");
          appRoot.setAttribute("x-data", "app()");
          appRoot.setAttribute("x-init", "init()");

          // Hide initial loader, show app
          document.getElementById("initial-loader").style.display = "none";
          appRoot.style.display = "block";

          // Now load Alpine.js
          const alpineScript = document.createElement("script");
          alpineScript.src = "https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js";
          alpineScript.defer = true;
          document.head.appendChild(alpineScript);
        } catch (error) {
          console.error("Failed to initialize app:", error);
          document.getElementById("initial-loader").innerHTML = `
            <div class="loader">
              <span style="color: red;">Failed to load application. Please refresh the page.</span>
            </div>
          `;
        }
      }

      // Wait for DOM then init
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", initApp);
      } else {
        initApp();
      }
    </script>
  </body>
</html>
