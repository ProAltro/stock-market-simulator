version: "3.8"

services:
  postgres:
    image: postgres:15-alpine
    container_name: decrypt-postgres
    environment:
      POSTGRES_USER: decrypt
      POSTGRES_PASSWORD: decrypt123
      POSTGRES_DB: decrypt
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U decrypt"]
      interval: 5s
      timeout: 5s
      retries: 5

  decrypt:
    build:
      context: ..
      dockerfile: docker/Dockerfile.single
    container_name: decrypt-app
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "80:80"
      - "8080:8080"
    volumes:
      - decrypt_data:/data
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://decrypt:decrypt123@postgres:5432/decrypt?schema=public
      - REDIS_URL=redis://localhost:6379
      - JWT_SECRET=${JWT_SECRET:-change-me-in-production}
      - MARKET_SIM_URL=http://localhost:8080
      - DATA_DIR=/data
      - FRONTEND_URL=http://localhost

  # Judge0 Code Execution Engine
  judge0-server:
    image: judge0/judge0:1.13.1
    container_name: judge0-server
    volumes:
      - ./judge0.conf:/judge0.conf:ro
    ports:
      - "2358:2358"
    privileged: true
    env_file: judge0.conf
    depends_on:
      judge0-db:
        condition: service_healthy
      judge0-redis:
        condition: service_healthy
    restart: always
    logging:
      driver: json-file
      options:
        max-size: 100M

  judge0-worker:
    image: judge0/judge0:1.13.1
    container_name: judge0-worker
    command: ["./scripts/workers"]
    volumes:
      - ./judge0.conf:/judge0.conf:ro
    privileged: true
    env_file: judge0.conf
    depends_on:
      judge0-db:
        condition: service_healthy
      judge0-redis:
        condition: service_healthy
    restart: always
    logging:
      driver: json-file
      options:
        max-size: 100M

  judge0-db:
    image: postgres:16.2
    container_name: judge0-db
    env_file: judge0.conf
    volumes:
      - judge0_postgres_data:/var/lib/postgresql/data/
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U judge0"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always
    logging:
      driver: json-file
      options:
        max-size: 100M

  judge0-redis:
    image: redis:7.2.4
    container_name: judge0-redis
    command:
      [
        "bash",
        "-c",
        'docker-entrypoint.sh --appendonly no --requirepass "$$REDIS_PASSWORD"',
      ]
    env_file: judge0.conf
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "judge0redispassword", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: always
    logging:
      driver: json-file
      options:
        max-size: 100M

volumes:
  postgres_data:
  decrypt_data:
  judge0_postgres_data:
